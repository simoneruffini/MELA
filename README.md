# MELA: a Modestly Exhaustive dLx Architecture
```
                                             .:'
                                            __ :'__
                                         .'`  `-'  ``.
                                        :             :
                                        :             :
                                         :           :
                                          `.__.-.__.'

```

----

DLX ISA, RISC microprocessor, VHDL implementation

## Block Level Overview
![top_level](./doc/images/top_level_github.drawio.png)


## Dependencies
- Questa Sim-64 10.7c
- design compiler F-2011.09-SP3
- Bash
- Pearl

## How To Run An Assembly Program
1) Write an Assembly program using the DLX isa found [here](./doc/isa.md)
   1) The size of your program (lines of code), must be so that it culd be saved in the instruction memory. If your program exceeds this size the design will not compile, in such case change the value `C_IMEM_ADDR_W` in file `./src/000-common.core/000-DLX_PKG.vhd` accordingly.
   2) If you need to address more then the default data-memory space change the variable 
   `C_DMEM_ADDR_W` in file `./src/000-common.core/000-DLX_PKG.vhd` accordingly. The compiler can't catch this error, the design will simulate your design but will truncate the data-memory-addresses to comply with its internal address space.

2) Run the assembler on the assembly program and link the output to the instruction memory ram-file
   ```bash
   ./scripts/assembler/assembler.sh <path_to_your>.asm ./src/000-common.core/003-IMEM_INIT_FILE.txt
   ```
   1) If you want to initialize the data-memory with a ram-file the link it to `./src/000-common.core/004-DMEM_INIT_FILE.txt`:
      ```bash
      ln -s <your_dmem_ram_file>.txt ./src/000-common.core/004-DMEM_INIT_FILE.txt
      ```
      The file must contain 32 bit, hexadecimal, newline escaped values

3) Compile the design (this script assumes vsim is in the system `$PATH`)
   ```bash
   ./scripts/build.sh
   ```

4) Run the simulation, it will run for 212us. (this script assumes vcom is in the system `$PATH`)
   ```bash
   ./scripts/build.sh sim
   ```
   To change the simulation time modify the line `run 212us` in `./sim/sim.do`

5) The simulation will output the file `./sim/rf_dmemd.dump`. This file contains the content of the Register file (in order 0 to 31) and data memroy (in reverse order DATA_MEM_SIZE-1 downto 0). Check this file to see if your program is compliant with your behaviour (you obviously need to save the program state either in data memory of in the register file)

## How To Syntesize The Design
The design synthesized is only MELA without memories.  
There are 5 available configurations of this design:
1) Full behavioural ALU.
   - design name: `CFG_CPU_BEHAV`
2) Behavioural ALU but LogicalUnit is UltraSPARK T2 LogicalUnit. 
   - design name: `CFG_CPU_BEHAV_ALU_T2LOGIC`
3) Behavioural ALU but Shifter is UltraSPARK T2 Shifter.
   - design name: `CFG_CPU_BEHAV_ALU_T2SHIFTER`
4) Behavioural ALU but adder is Intel Pentium4 adder. 
   - design name `CFG_CPU_BEHAV_ALU_P4ADDER`
5) ALU made of all the previous components but with behavioural comparators. 
   - design name: `CFG_CPU_BEHAV_ALU_STRUCT`

Select the configuration and the desired clock-period in nanoseconds (can be a float value) and run (the script assumes `dc_shell-xg-t` (design compiler) is in your systems `$PATH`):

```bash
./scripts/build.sh syn <design_name> <clock_period_ns>
```

Synthesis outputs will be in the `./syn` folder, respectively:
- `./syn/reports` will contain timing, area and power reports
- `./syn/netlists` will contain the synthesized netlist
- `./syn/design_compiler_sdc` will contain the `sdc` file generated by design compiler for this syntesis run

## Place And Route
Here some nice pictures. No description for this process because we didn't know what we where doing, just followin a recepy, but nice pics.  
### Asic View
|All metal layers                                                      | Transistor cells                                              |
|----------------------------------------------------------------------|---------------------------------------------------------------|
|![place_and_route](./doc/images/place_and_route.png)                  |![transistor_cells](./doc/images/transistor_cells_overview.png)|
|The pads on the perimeter are Data Memory and Instruction Memory ports|                                                               |

### Space used: Data Path vs Control Unit
![dp_vs_cu_space](./doc/images/ss_cu_dp.png)

### Space used: whole ALU vs P4 Adder vs T2 Shifter vs T2 Logic
![alu_space](./doc/images/ss_alu.png)

## Notes 
I don't like this folder strcuture but it was imposed on us to keep the project "tidier" and simpler to recognize the hierarchy from. 
To be honest the constraint is understandable but it's still aweful to look at and use.

[MicroEletronics PoliTO]
